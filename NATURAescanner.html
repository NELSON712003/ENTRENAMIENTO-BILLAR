<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Esc√°ner Natura - Google Sheets</title>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 1.8rem;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }

        .status {
            text-align: center;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .status.escaneando {
            background: #d4edda;
            color: #155724;
            animation: pulse 1.5s infinite;
        }

        .status.pausado {
            background: #fff3cd;
            color: #856404;
        }

        .status.enviando {
            background: #cce5ff;
            color: #004085;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        #reader {
            width: 100%;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 20px;
            border: 3px solid #667eea;
        }

        .controls {
            display: grid;
            gap: 10px;
            margin-bottom: 20px;
        }

        button {
            padding: 15px 20px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
        }

        .btn-stop {
            background: linear-gradient(135deg, #ff6b6b, #ee5a5a);
            color: white;
        }

        .btn-stop:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255,107,107,0.4);
        }

        .btn-manual {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            color: white;
        }

        .btn-manual:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(78,205,196,0.4);
        }

        .btn-send {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-send:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102,126,234,0.4);
        }

        .section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .input-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 600;
            font-size: 0.9rem;
        }

        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        .historial {
            max-height: 300px;
            overflow-y: auto;
            background: white;
            border-radius: 10px;
            padding: 10px;
        }

        .item-historial {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
            border-radius: 8px;
            font-size: 0.9rem;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .item-historial .codigo {
            font-weight: bold;
            color: #333;
        }

        .item-historial .fecha {
            color: #666;
            font-size: 0.8rem;
        }

        .contador {
            text-align: center;
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }

        .config-section {
            background: #e3f2fd;
            border-left-color: #2196f3;
        }

        .success-msg {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
        }

        .error-msg {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
        }

        .last-scanned {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 15px;
            display: none;
        }

        .last-scanned.show {
            display: block;
            animation: popIn 0.3s ease;
        }

        @keyframes popIn {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì¶ Esc√°ner Natura</h1>
        <p class="subtitle">Escaneo autom√°tico a Google Sheets</p>

        <div id="status" class="status escaneando">
            üî¥ ESCANEANDO - Listo para capturar c√≥digos
        </div>

        <div id="lastScanned" class="last-scanned">
            <div>√öltimo c√≥digo detectado:</div>
            <div id="lastCode" style="font-size: 1.5rem; font-weight: bold; margin-top: 5px;"></div>
            <div id="lastTime" style="font-size: 0.9rem; opacity: 0.9;"></div>
        </div>

        <div id="reader"></div>

        <div class="controls">
            <button class="btn-stop" onclick="detenerCamara()">
                ‚èπÔ∏è DETENER C√ÅMARA Y ENVIAR TODO
            </button>
            <button class="btn-manual" onclick="toggleManual()">
                ‚úèÔ∏è ENTRADA MANUAL
            </button>
        </div>

        <div class="contador">
            <span id="contador">0</span> c√≥digos en historial
        </div>

        <!-- Secci√≥n de Historial -->
        <div class="section">
            <h3>üìã Historial Temporal</h3>
            <div id="historial" class="historial">
                <p style="text-align: center; color: #999; padding: 20px;">
                    Los c√≥digos escaneados aparecer√°n aqu√≠...
                </p>
            </div>
        </div>

        <!-- Entrada Manual -->
        <div id="manualSection" class="section" style="display: none;">
            <h3>‚úèÔ∏è Entrada Manual</h3>
            <div class="input-group">
                <label>C√≥digo de Barras (o m√∫ltiples separados por coma):</label>
                <input type="text" id="manualInput" placeholder="Ej: 123456789, 987654321, 456789123">
            </div>
            <button class="btn-send" onclick="enviarManual()">
                üì§ ENVIAR A GOOGLE SHEETS
            </button>
            <div id="manualSuccess" class="success-msg">‚úÖ Enviado correctamente</div>
            <div id="manualError" class="error-msg">‚ùå Error al enviar</div>
        </div>

        <!-- Configuraci√≥n Google Sheets -->
        <div class="section config-section">
            <h3>‚öôÔ∏è Configuraci√≥n Google Sheets</h3>
            <div class="input-group">
                <label>URL del Script de Google Apps:</label>
                <input type="text" id="scriptUrl" placeholder="https://script.google.com/macros/s/.../exec">
                https://script.google.com/macros/s/AKfycbwkyOls_YxKxEJiHjMd0Q30NVXdiCDo74GGdy2ISwf6FvHxjvXuNTnc9b3fB6Dl5JlY/exec
            </div>
            <div class="input-group">
                <label>Nombre de la Hoja (DIA):</label>
                <input type="text" id="sheetName" value="DIA">
            </div>
            <button class="btn-send" onclick="probarConexion()">
                üîå PROBAR CONEXI√ìN
            </button>
            <div id="configSuccess" class="success-msg">‚úÖ Conexi√≥n exitosa</div>
            <div id="configError" class="error-msg">‚ùå Error de conexi√≥n</div>
        </div>
    </div>

    <script>
        // Variables globales
        let html5QrCode;
        let historial = [];
        let escaneando = true;
        let ultimoCodigo = '';
        let ultimoTiempo = 0;
        const DELAY_ENTRE_ESCANEOS = 2000; // 2 segundos entre escaneos del mismo c√≥digo

        // Inicializar esc√°ner al cargar
        window.onload = function() {
            iniciarEscanner();
        };

        function iniciarEscanner() {
            html5QrCode = new Html5Qrcode("reader");
            
            const config = {
                fps: 10,
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0
            };

            html5QrCode.start(
                { facingMode: "environment" },
                config,
                onScanSuccess,
                onScanFailure
            ).catch(err => {
                console.error("Error al iniciar c√°mara:", err);
                document.getElementById('status').textContent = '‚ùå Error al acceder a la c√°mara';
                document.getElementById('status').className = 'status error-msg';
            });
        }

        function onScanSuccess(decodedText, decodedResult) {
            const ahora = Date.now();
            
            // Evitar escaneos duplicados del mismo c√≥digo en menos de 2 segundos
            if (decodedText === ultimoCodigo && (ahora - ultimoTiempo) < DELAY_ENTRE_ESCANEOS) {
                return;
            }

            // Actualizar √∫ltimo c√≥digo
            ultimoCodigo = decodedText;
            ultimoTiempo = ahora;

            // Crear objeto con la informaci√≥n
            const fecha = new Date();
            const registro = {
                fecha: fecha.toLocaleDateString('es-ES'),
                hora: fecha.toLocaleTimeString('es-ES'),
                codigo: decodedText,
                timestamp: fecha.getTime()
            };

            // Agregar al historial
            historial.push(registro);
            
            // Mostrar √∫ltimo escaneado
            mostrarUltimoEscaneado(decodedText, registro.fecha + ' ' + registro.hora);
            
            // Actualizar interfaz
            actualizarHistorial();
            actualizarContador();

            // Enviar inmediatamente a Google Sheets (autom√°tico)
            enviarAutomatico(registro);
        }

        function onScanFailure(error) {
            // Ignorar errores de escaneo (cuando no detecta c√≥digo)
        }

        function mostrarUltimoEscaneado(codigo, fechaHora) {
            const div = document.getElementById('lastScanned');
            document.getElementById('lastCode').textContent = codigo;
            document.getElementById('lastTime').textContent = fechaHora;
            div.classList.add('show');
            
            // Ocultar despu√©s de 3 segundos
            setTimeout(() => {
                div.classList.remove('show');
            }, 3000);
        }

        function actualizarHistorial() {
            const container = document.getElementById('historial');
            
            if (historial.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Los c√≥digos escaneados aparecer√°n aqu√≠...</p>';
                return;
            }

            let html = '';
            // Mostrar en orden inverso (m√°s reciente primero)
            for (let i = historial.length - 1; i >= 0; i--) {
                const item = historial[i];
                html += `
                    <div class="item-historial">
                        <div>
                            <div class="codigo">${item.codigo}</div>
                            <div class="fecha">${item.fecha} ${item.hora}</div>
                        </div>
                        <span style="color: #28a745; font-size: 1.2rem;">‚úì</span>
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        function actualizarContador() {
            document.getElementById('contador').textContent = historial.length;
        }

        function detenerCamara() {
            if (!escaneando) return;
            
            escaneando = false;
            
            // Detener c√°mara
            html5QrCode.stop().then(() => {
                document.getElementById('status').textContent = '‚è∏Ô∏è C√ÅMARA DETENIDA - Enviando historial...';
                document.getElementById('status').className = 'status enviando';
                
                // Enviar todo el historial
                enviarTodoElHistorial();
            }).catch(err => {
                console.error("Error al detener:", err);
            });
        }

        function enviarAutomatico(registro) {
            const url = document.getElementById('scriptUrl').value;
            if (!url) {
                console.log('No hay URL configurada - modo demo');
                return;
            }

            const sheetName = document.getElementById('sheetName').value || 'DIA';
            
            const data = {
                hoja: sheetName,
                fecha: registro.fecha,
                hora: registro.hora,
                codigo: registro.codigo,
                modo: 'automatico'
            };

            fetch(url, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            }).then(() => {
                console.log('Enviado autom√°ticamente:', registro.codigo);
            }).catch(err => {
                console.error('Error en env√≠o autom√°tico:', err);
            });
        }

        function enviarTodoElHistorial() {
            const url = document.getElementById('scriptUrl').value;
            
            if (!url) {
                alert('‚ö†Ô∏è Por favor configura la URL del Script de Google Apps primero');
                document.getElementById('status').textContent = '‚ö†Ô∏è CONFIGURA LA URL PRIMERO';
                document.getElementById('status').className = 'status pausado';
                return;
            }

            const sheetName = document.getElementById('sheetName').value || 'DIA';

            if (historial.length === 0) {
                alert('No hay c√≥digos en el historial para enviar');
                return;
            }

            // Preparar datos para env√≠o masivo
            const data = {
                hoja: sheetName,
                modo: 'masivo',
                registros: historial
            };

            document.getElementById('status').textContent = 'üì§ ENVIANDO ' + historial.length + ' REGISTROS...';

            fetch(url, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            }).then(() => {
                document.getElementById('status').textContent = '‚úÖ ENVIADOS ' + historial.length + ' REGISTROS A GOOGLE SHEETS';
                document.getElementById('status').className = 'status escaneando';
                document.getElementById('status').style.background = '#d4edda';
                
                // Limpiar historial despu√©s de enviar
                historial = [];
                actualizarHistorial();
                actualizarContador();
                
                // Reiniciar c√°mara despu√©s de 2 segundos
                setTimeout(() => {
                    reiniciarCamara();
                }, 2000);
            }).catch(err => {
                console.error('Error:', err);
                document.getElementById('status').textContent = '‚ùå ERROR AL ENVIAR';
                document.getElementById('status').className = 'status error-msg';
            });
        }

        function reiniciarCamara() {
            escaneando = true;
            document.getElementById('status').textContent = 'üî¥ ESCANEANDO - Listo para capturar c√≥digos';
            document.getElementById('status').className = 'status escaneando';
            iniciarEscanner();
        }

        function toggleManual() {
            const section = document.getElementById('manualSection');
            section.style.display = section.style.display === 'none' ? 'block' : 'none';
        }

        function enviarManual() {
            const input = document.getElementById('manualInput').value.trim();
            const url = document.getElementById('scriptUrl').value;
            
            if (!input) {
                alert('Por favor ingresa al menos un c√≥digo');
                return;
            }

            if (!url) {
                alert('‚ö†Ô∏è Por favor configura la URL del Script de Google Apps primero');
                return;
            }

            const sheetName = document.getElementById('sheetName').value || 'DIA';
            
            // Separar por comas
            const codigos = input.split(',').map(c => c.trim()).filter(c => c);
            
            const fecha = new Date();
            const registros = codigos.map(codigo => ({
                fecha: fecha.toLocaleDateString('es-ES'),
                hora: fecha.toLocaleTimeString('es-ES'),
                codigo: codigo
            }));

            const data = {
                hoja: sheetName,
                modo: 'masivo',
                registros: registros
            };

            fetch(url, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            }).then(() => {
                document.getElementById('manualSuccess').style.display = 'block';
                document.getElementById('manualInput').value = '';
                setTimeout(() => {
                    document.getElementById('manualSuccess').style.display = 'none';
                }, 3000);
            }).catch(err => {
                document.getElementById('manualError').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('manualError').style.display = 'none';
                }, 3000);
            });
        }

        function probarConexion() {
            const url = document.getElementById('scriptUrl').value;
            
            if (!url) {
                alert('Por favor ingresa la URL del script');
                return;
            }

            document.getElementById('configSuccess').style.display = 'none';
            document.getElementById('configError').style.display = 'none';

            fetch(url + '?test=1', {
                method: 'GET',
                mode: 'no-cors'
            }).then(() => {
                document.getElementById('configSuccess').style.display = 'block';
            }).catch(() => {
                // Como no-cors no devuelve respuesta legible, asumimos √©xito si no hay error de red
                document.getElementById('configSuccess').style.display = 'block';
            });
        }
    </script>
</body>
</html>
