<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FastTrack - Sistema de Paquetería</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        accent: '#F59E0B',
                        danger: '#EF4444',
                        dark: '#1E293B'
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'bounce-slow': 'bounce 2s infinite',
                        'slide-in': 'slideIn 0.5s ease-out',
                        'fade-in': 'fadeIn 0.3s ease-out',
                    },
                    keyframes: {
                        slideIn: {
                            '0%': { transform: 'translateX(-100%)', opacity: '0' },
                            '100%': { transform: 'translateX(0)', opacity: '1' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>
    
    <style>
        #map { height: 100%; min-height: 400px; z-index: 1; }
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .package-card {
            transition: all 0.3s ease;
        }
        .package-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }
        .status-badge {
            transition: all 0.3s ease;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            padding: 0;
            overflow: hidden;
        }
        .leaflet-popup-content {
            margin: 0;
            width: 280px !important;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans overflow-hidden h-screen">

    <!-- Sidebar -->
    <aside class="fixed left-0 top-0 h-full w-64 bg-dark text-white z-50 transform transition-transform duration-300" id="sidebar">
        <div class="p-6 border-b border-gray-700">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-br from-primary to-blue-600 rounded-xl flex items-center justify-center shadow-lg">
                    <i class="fas fa-box-open text-white text-lg"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold tracking-tight">FastTrack</h1>
                    <p class="text-xs text-gray-400">Sistema de Logística</p>
                </div>
            </div>
        </div>
        
        <nav class="p-4 space-y-2">
            <button onclick="showView('dashboard')" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg bg-primary/20 text-primary border border-primary/30 transition-all hover:bg-primary/30">
                <i class="fas fa-chart-line w-5"></i>
                <span class="font-medium">Dashboard</span>
            </button>
            <button onclick="showView('shipments')" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-400 hover:bg-gray-800 hover:text-white transition-all">
                <i class="fas fa-box w-5"></i>
                <span class="font-medium">Envíos</span>
                <span id="sidebar-count" class="ml-auto bg-primary text-white text-xs px-2 py-1 rounded-full">0</span>
            </button>
            <button onclick="showView('map')" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-400 hover:bg-gray-800 hover:text-white transition-all">
                <i class="fas fa-map-marked-alt w-5"></i>
                <span class="font-medium">Mapa Global</span>
            </button>
            <button onclick="showView('new')" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg bg-secondary/20 text-secondary border border-secondary/30 transition-all hover:bg-secondary/30">
                <i class="fas fa-plus-circle w-5"></i>
                <span class="font-medium">Nuevo Envío</span>
            </button>
        </nav>

        <div class="absolute bottom-0 left-0 right-0 p-4 border-t border-gray-700">
            <div class="flex items-center gap-3 px-4 py-3 rounded-lg bg-gray-800/50">
                <img src="https://i.pravatar.cc/150?img=11" alt="Admin" class="w-10 h-10 rounded-full border-2 border-primary">
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-white truncate">Admin User</p>
                    <p class="text-xs text-gray-400 truncate">admin@fasttrack.com</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="ml-64 h-full overflow-hidden flex flex-col">
        <!-- Header -->
        <header class="bg-white border-b border-gray-200 px-8 py-4 flex items-center justify-between shadow-sm z-40">
            <div class="flex items-center gap-4">
                <button onclick="toggleSidebar()" class="lg:hidden p-2 rounded-lg hover:bg-gray-100">
                    <i class="fas fa-bars text-gray-600"></i>
                </button>
                <h2 id="page-title" class="text-2xl font-bold text-gray-800">Dashboard</h2>
            </div>
            
            <div class="flex items-center gap-4">
                <div class="relative">
                    <input type="text" id="search-input" placeholder="Buscar envío..." 
                           class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary w-64 transition-all"
                           onkeyup="searchPackages()">
                    <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                </div>
                <button class="relative p-2 rounded-lg hover:bg-gray-100 transition-colors">
                    <i class="fas fa-bell text-gray-600 text-xl"></i>
                    <span class="absolute top-1 right-1 w-2 h-2 bg-danger rounded-full animate-pulse"></span>
                </button>
            </div>
        </header>

        <!-- Content Area -->
        <div class="flex-1 overflow-auto custom-scrollbar p-8" id="content-area">
            
            <!-- Dashboard View -->
            <div id="dashboard-view" class="space-y-6 animate-fade-in">
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
                        <div class="flex items-center justify-between mb-4">
                            <div class="p-3 bg-blue-100 rounded-lg">
                                <i class="fas fa-box text-primary text-xl"></i>
                            </div>
                            <span class="text-xs font-medium text-gray-500 bg-gray-100 px-2 py-1 rounded-full">Total</span>
                        </div>
                        <h3 class="text-3xl font-bold text-gray-800" id="stat-total">0</h3>
                        <p class="text-sm text-gray-500 mt-1">Envíos totales</p>
                    </div>
                    
                    <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
                        <div class="flex items-center justify-between mb-4">
                            <div class="p-3 bg-yellow-100 rounded-lg">
                                <i class="fas fa-clock text-accent text-xl"></i>
                            </div>
                            <span class="text-xs font-medium text-gray-500 bg-gray-100 px-2 py-1 rounded-full">Pendientes</span>
                        </div>
                        <h3 class="text-3xl font-bold text-gray-800" id="stat-pending">0</h3>
                        <p class="text-sm text-gray-500 mt-1">Por procesar</p>
                    </div>
                    
                    <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
                        <div class="flex items-center justify-between mb-4">
                            <div class="p-3 bg-green-100 rounded-lg">
                                <i class="fas fa-truck text-secondary text-xl"></i>
                            </div>
                            <span class="text-xs font-medium text-gray-500 bg-gray-100 px-2 py-1 rounded-full">En tránsito</span>
                        </div>
                        <h3 class="text-3xl font-bold text-gray-800" id="stat-transit">0</h3>
                        <p class="text-sm text-gray-500 mt-1">En camino</p>
                    </div>
                    
                    <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
                        <div class="flex items-center justify-between mb-4">
                            <div class="p-3 bg-purple-100 rounded-lg">
                                <i class="fas fa-check-circle text-purple-600 text-xl"></i>
                            </div>
                            <span class="text-xs font-medium text-gray-500 bg-gray-100 px-2 py-1 rounded-full">Entregados</span>
                        </div>
                        <h3 class="text-3xl font-bold text-gray-800" id="stat-delivered">0</h3>
                        <p class="text-sm text-gray-500 mt-1">Completados</p>
                    </div>
                </div>

                <!-- Recent Activity & Quick Map -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                        <div class="p-6 border-b border-gray-100 flex items-center justify-between">
                            <h3 class="text-lg font-bold text-gray-800">Envíos Recientes</h3>
                            <button onclick="showView('shipments')" class="text-primary text-sm font-medium hover:underline">Ver todos</button>
                        </div>
                        <div class="divide-y divide-gray-100" id="recent-shipments">
                            <!-- Dynamic content -->
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                        <div class="p-6 border-b border-gray-100">
                            <h3 class="text-lg font-bold text-gray-800">Actividad Rápida</h3>
                        </div>
                        <div class="p-6 space-y-4">
                            <div class="flex items-center gap-3 p-3 bg-blue-50 rounded-lg border border-blue-100">
                                <div class="w-2 h-2 bg-primary rounded-full animate-pulse"></div>
                                <div class="flex-1">
                                    <p class="text-sm font-medium text-gray-800">Nuevo envío registrado</p>
                                    <p class="text-xs text-gray-500">Hace 2 minutos</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-3 p-3 bg-green-50 rounded-lg border border-green-100">
                                <div class="w-2 h-2 bg-secondary rounded-full"></div>
                                <div class="flex-1">
                                    <p class="text-sm font-medium text-gray-800">Paquete entregado #1234</p>
                                    <p class="text-xs text-gray-500">Hace 15 minutos</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-3 p-3 bg-yellow-50 rounded-lg border border-yellow-100">
                                <div class="w-2 h-2 bg-accent rounded-full"></div>
                                <div class="flex-1">
                                    <p class="text-sm font-medium text-gray-800">En tránsito hacia CDMX</p>
                                    <p class="text-xs text-gray-500">Hace 1 hora</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Shipments List View -->
            <div id="shipments-view" class="hidden space-y-6 animate-fade-in">
                <div class="flex items-center justify-between">
                    <div class="flex gap-2">
                        <button onclick="filterStatus('all')" class="filter-btn px-4 py-2 rounded-lg bg-primary text-white text-sm font-medium transition-all" data-filter="all">Todos</button>
                        <button onclick="filterStatus('pending')" class="filter-btn px-4 py-2 rounded-lg bg-gray-200 text-gray-700 text-sm font-medium hover:bg-gray-300 transition-all" data-filter="pending">Pendientes</button>
                        <button onclick="filterStatus('transit')" class="filter-btn px-4 py-2 rounded-lg bg-gray-200 text-gray-700 text-sm font-medium hover:bg-gray-300 transition-all" data-filter="transit">En Tránsito</button>
                        <button onclick="filterStatus('delivered')" class="filter-btn px-4 py-2 rounded-lg bg-gray-200 text-gray-700 text-sm font-medium hover:bg-gray-300 transition-all" data-filter="delivered">Entregados</button>
                    </div>
                    <button onclick="showView('new')" class="px-4 py-2 bg-secondary text-white rounded-lg text-sm font-medium hover:bg-green-600 transition-all flex items-center gap-2">
                        <i class="fas fa-plus"></i> Nuevo Envío
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6" id="packages-grid">
                    <!-- Dynamic package cards -->
                </div>
            </div>

            <!-- Map View -->
            <div id="map-view" class="hidden h-full animate-fade-in">
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden h-[calc(100vh-200px)]">
                    <div id="map"></div>
                </div>
            </div>

            <!-- New Shipment Form -->
            <div id="new-view" class="hidden max-w-4xl mx-auto animate-fade-in">
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="p-6 border-b border-gray-100 bg-gray-50/50">
                        <h3 class="text-xl font-bold text-gray-800">Crear Nuevo Envío</h3>
                        <p class="text-sm text-gray-500 mt-1">Complete los detalles del paquete y la dirección de destino</p>
                    </div>
                    
                    <form id="shipment-form" class="p-6 space-y-6" onsubmit="createShipment(event)">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <label class="text-sm font-medium text-gray-700">ID de Rastreo</label>
                                <input type="text" id="tracking-id" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" placeholder="Ej: FT-2024-001" required>
                            </div>
                            
                            <div class="space-y-2">
                                <label class="text-sm font-medium text-gray-700">Nombre del Cliente</label>
                                <input type="text" id="client-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" placeholder="Nombre completo" required>
                            </div>
                            
                            <div class="space-y-2">
                                <label class="text-sm font-medium text-gray-700">Tipo de Paquete</label>
                                <select id="package-type" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary">
                                    <option value="small">Pequeño (&lt; 1kg)</option>
                                    <option value="medium">Mediano (1-5kg)</option>
                                    <option value="large">Grande (5-20kg)</option>
                                    <option value="xlarge">Extra Grande (&gt; 20kg)</option>
                                </select>
                            </div>
                            
                            <div class="space-y-2">
                                <label class="text-sm font-medium text-gray-700">Estado Inicial</label>
                                <select id="initial-status" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary">
                                    <option value="pending">Pendiente</option>
                                    <option value="transit">En Tránsito</option>
                                    <option value="delivered">Entregado</option>
                                </select>
                            </div>
                        </div>

                        <div class="space-y-2">
                            <label class="text-sm font-medium text-gray-700">Dirección de Destino</label>
                            <div class="relative">
                                <input type="text" id="destination-address" class="w-full px-4 py-2 pl-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" placeholder="Buscar dirección..." required onkeypress="handleAddressInput(event)">
                                <i class="fas fa-map-marker-alt absolute left-3 top-3 text-gray-400"></i>
                                <button type="button" onclick="geocodeAddress()" class="absolute right-2 top-2 px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded text-sm transition-colors">
                                    Buscar
                                </button>
                            </div>
                            <p class="text-xs text-gray-500">Presione Enter o haga clic en Buscar para ubicar en el mapa</p>
                        </div>

                        <div class="h-64 rounded-lg border border-gray-300 overflow-hidden relative">
                            <div id="form-map"></div>
                            <div class="absolute bottom-4 right-4 bg-white px-3 py-1 rounded-lg shadow-md text-xs text-gray-600 z-[1000]">
                                <i class="fas fa-info-circle mr-1"></i> Haga clic en el mapa para ajustar la ubicación
                            </div>
                        </div>

                        <div class="space-y-2">
                            <label class="text-sm font-medium text-gray-700">URL de Foto del Paquete</label>
                            <input type="url" id="package-photo" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" placeholder="https://ejemplo.com/foto.jpg" onchange="previewImage()">
                            <div id="image-preview" class="hidden mt-2 rounded-lg overflow-hidden border border-gray-200 max-w-xs">
                                <img src="" alt="Preview" class="w-full h-48 object-cover">
                            </div>
                        </div>

                        <div class="flex items-center gap-4 pt-4 border-t border-gray-100">
                            <button type="submit" class="flex-1 bg-primary hover:bg-blue-600 text-white font-medium py-3 rounded-lg transition-all transform hover:scale-[1.02] active:scale-[0.98] shadow-lg shadow-primary/30">
                                <i class="fas fa-paper-plane mr-2"></i> Crear Envío
                            </button>
                            <button type="button" onclick="showView('dashboard')" class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 font-medium hover:bg-gray-50 transition-all">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>

        </div>
    </main>

    <!-- Detail Modal -->
    <div id="detail-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[2000] hidden items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden shadow-2xl transform transition-all scale-95 opacity-0" id="modal-content">
            <div class="relative h-48 bg-gradient-to-br from-primary to-blue-600 overflow-hidden">
                <img id="modal-image" src="" alt="Package" class="w-full h-full object-cover opacity-50">
                <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
                <button onclick="closeModal()" class="absolute top-4 right-4 w-8 h-8 bg-white/20 hover:bg-white/30 rounded-full flex items-center justify-center text-white transition-colors backdrop-blur-sm">
                    <i class="fas fa-times"></i>
                </button>
                <div class="absolute bottom-4 left-6 text-white">
                    <h3 class="text-2xl font-bold" id="modal-tracking"></h3>
                    <p class="text-white/80 text-sm" id="modal-client"></p>
                </div>
            </div>
            
            <div class="p-6 overflow-y-auto max-h-[calc(90vh-12rem)]">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-3">
                        <span id="modal-status-badge" class="px-3 py-1 rounded-full text-sm font-medium"></span>
                        <span class="text-gray-400">|</span>
                        <span class="text-sm text-gray-500" id="modal-date"></span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="updateStatus('pending')" class="px-3 py-1 rounded-lg bg-yellow-100 text-yellow-700 text-xs font-medium hover:bg-yellow-200 transition-colors">Pendiente</button>
                        <button onclick="updateStatus('transit')" class="px-3 py-1 rounded-lg bg-blue-100 text-blue-700 text-xs font-medium hover:bg-blue-200 transition-colors">Tránsito</button>
                        <button onclick="updateStatus('delivered')" class="px-3 py-1 rounded-lg bg-green-100 text-green-700 text-xs font-medium hover:bg-green-200 transition-colors">Entregado</button>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <p class="text-xs text-gray-500 uppercase tracking-wider mb-1">Origen</p>
                        <p class="font-medium text-gray-800 flex items-center gap-2">
                            <i class="fas fa-map-marker-alt text-primary"></i>
                            Centro de Distribución Principal
                        </p>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <p class="text-xs text-gray-500 uppercase tracking-wider mb-1">Destino</p>
                        <p class="font-medium text-gray-800 flex items-center gap-2" id="modal-destination">
                            <i class="fas fa-flag-checkered text-secondary"></i>
                        </p>
                    </div>
                </div>

                <div class="mb-6">
                    <h4 class="text-sm font-bold text-gray-800 mb-3">Progreso de Entrega</h4>
                    <div class="relative">
                        <div class="absolute left-4 top-0 bottom-0 w-0.5 bg-gray-200"></div>
                        <div class="space-y-4" id="modal-timeline">
                            <!-- Timeline items -->
                        </div>
                    </div>
                </div>

                <div class="h-48 rounded-lg overflow-hidden border border-gray-200">
                    <div id="modal-map" class="h-full w-full"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // State Management
        let packages = [
            {
                id: 'FT-2024-001',
                client: 'Juan Pérez',
                type: 'medium',
                status: 'transit',
                origin: [19.4326, -99.1332], // CDMX
                destination: [20.6597, -103.3496], // Guadalajara
                address: 'Guadalajara, Jalisco, México',
                photo: 'https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=400',
                date: new Date().toISOString(),
                history: [
                    { status: 'pending', date: new Date(Date.now() - 86400000).toISOString(), location: 'Centro de Distribución CDMX' },
                    { status: 'transit', date: new Date().toISOString(), location: 'En ruta a Guadalajara' }
                ]
            },
            {
                id: 'FT-2024-002',
                client: 'María García',
                type: 'small',
                status: 'pending',
                origin: [19.4326, -99.1332],
                destination: [25.6866, -100.3161], // Monterrey
                address: 'Monterrey, Nuevo León, México',
                photo: 'https://images.unsplash.com/photo-1586864387789-628af9feed72?w=400',
                date: new Date().toISOString(),
                history: [
                    { status: 'pending', date: new Date().toISOString(), location: 'Centro de Distribución CDMX' }
                ]
            },
            {
                id: 'FT-2024-003',
                client: 'Carlos López',
                type: 'large',
                status: 'delivered',
                origin: [19.4326, -99.1332],
                destination: [19.1738, -96.1342], // Veracruz
                address: 'Veracruz, Veracruz, México',
                photo: 'https://images.unsplash.com/photo-1601584115197-04ecc0da31d7?w=400',
                date: new Date(Date.now() - 172800000).toISOString(),
                history: [
                    { status: 'pending', date: new Date(Date.now() - 259200000).toISOString(), location: 'Centro de Distribución CDMX' },
                    { status: 'transit', date: new Date(Date.now() - 172800000).toISOString(), location: 'En tránsito' },
                    { status: 'delivered', date: new Date(Date.now() - 86400000).toISOString(), location: 'Entregado al cliente' }
                ]
            }
        ];

        let currentFilter = 'all';
        let selectedPackage = null;
        let mainMap = null;
        let formMap = null;
        let modalMap = null;
        let currentMarker = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            updateStats();
            renderPackages();
            renderRecentShipments();
            initMap();
        });

        // Navigation
        function showView(view) {
            // Hide all views
            document.querySelectorAll('[id$="-view"]').forEach(el => el.classList.add('hidden'));
            
            // Show selected view
            document.getElementById(`${view}-view`).classList.remove('hidden');
            
            // Update title
            const titles = {
                'dashboard': 'Dashboard',
                'shipments': 'Gestión de Envíos',
                'map': 'Mapa de Cobertura',
                'new': 'Nuevo Envío'
            };
            document.getElementById('page-title').textContent = titles[view];
            
            // Update nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('bg-primary/20', 'text-primary', 'border', 'border-primary/30');
                btn.classList.add('text-gray-400');
            });
            
            // Special handling for nav buttons
            if (view === 'dashboard') {
                document.querySelectorAll('.nav-btn')[0].classList.add('bg-primary/20', 'text-primary', 'border', 'border-primary/30');
                document.querySelectorAll('.nav-btn')[0].classList.remove('text-gray-400');
            } else if (view === 'shipments') {
                document.querySelectorAll('.nav-btn')[1].classList.add('bg-primary/20', 'text-primary', 'border', 'border-primary/30');
                document.querySelectorAll('.nav-btn')[1].classList.remove('text-gray-400');
            } else if (view === 'map') {
                document.querySelectorAll('.nav-btn')[2].classList.add('bg-primary/20', 'text-primary', 'border', 'border-primary/30');
                document.querySelectorAll('.nav-btn')[2].classList.remove('text-gray-400');
                setTimeout(() => {
                    if (mainMap) mainMap.invalidateSize();
                }, 100);
            } else if (view === 'new') {
                document.querySelectorAll('.nav-btn')[3].classList.add('bg-primary/20', 'text-primary', 'border', 'border-primary/30');
                document.querySelectorAll('.nav-btn')[3].classList.remove('text-gray-400');
                setTimeout(initFormMap, 100);
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('-translate-x-full');
        }

        // Statistics
        function updateStats() {
            document.getElementById('stat-total').textContent = packages.length;
            document.getElementById('stat-pending').textContent = packages.filter(p => p.status === 'pending').length;
            document.getElementById('stat-transit').textContent = packages.filter(p => p.status === 'transit').length;
            document.getElementById('stat-delivered').textContent = packages.filter(p => p.status === 'delivered').length;
            document.getElementById('sidebar-count').textContent = packages.length;
        }

        // Render Functions
        function renderPackages() {
            const grid = document.getElementById('packages-grid');
            const filtered = currentFilter === 'all' ? packages : packages.filter(p => p.status === currentFilter);
            
            grid.innerHTML = filtered.map(pkg => `
                <div class="package-card bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden cursor-pointer" onclick="showDetail('${pkg.id}')">
                    <div class="relative h-48 overflow-hidden">
                        <img src="${pkg.photo}" alt="${pkg.id}" class="w-full h-full object-cover transition-transform duration-500 hover:scale-110">
                        <div class="absolute top-3 right-3">
                            ${getStatusBadge(pkg.status)}
                        </div>
                        <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent p-4">
                            <p class="text-white font-bold text-lg">${pkg.id}</p>
                            <p class="text-white/80 text-sm">${pkg.client}</p>
                        </div>
                    </div>
                    <div class="p-4">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">${getPackageTypeLabel(pkg.type)}</span>
                            <span class="text-xs text-gray-400">${formatDate(pkg.date)}</span>
                        </div>
                        <div class="flex items-center gap-2 text-sm text-gray-600 mb-3">
                            <i class="fas fa-map-marker-alt text-primary"></i>
                            <span class="truncate">${pkg.address}</span>
                        </div>
                        <div class="flex items-center justify-between pt-3 border-t border-gray-100">
                            <button class="text-primary text-sm font-medium hover:underline">Ver detalles</button>
                            <div class="flex gap-2">
                                <button onclick="event.stopPropagation(); updatePackageStatus('${pkg.id}', 'pending')" class="w-8 h-8 rounded-full bg-yellow-100 text-yellow-600 hover:bg-yellow-200 flex items-center justify-center transition-colors" title="Marcar pendiente">
                                    <i class="fas fa-clock text-xs"></i>
                                </button>
                                <button onclick="event.stopPropagation(); updatePackageStatus('${pkg.id}', 'transit')" class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 hover:bg-blue-200 flex items-center justify-center transition-colors" title="En tránsito">
                                    <i class="fas fa-truck text-xs"></i>
                                </button>
                                <button onclick="event.stopPropagation(); updatePackageStatus('${pkg.id}', 'delivered')" class="w-8 h-8 rounded-full bg-green-100 text-green-600 hover:bg-green-200 flex items-center justify-center transition-colors" title="Entregado">
                                    <i class="fas fa-check text-xs"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderRecentShipments() {
            const container = document.getElementById('recent-shipments');
            const recent = packages.slice(0, 5);
            
            container.innerHTML = recent.map(pkg => `
                <div class="p-4 flex items-center gap-4 hover:bg-gray-50 transition-colors cursor-pointer" onclick="showDetail('${pkg.id}')">
                    <img src="${pkg.photo}" class="w-12 h-12 rounded-lg object-cover" alt="">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2">
                            <h4 class="font-medium text-gray-800 truncate">${pkg.id}</h4>
                            ${getStatusBadge(pkg.status, true)}
                        </div>
                        <p class="text-sm text-gray-500 truncate">${pkg.client} • ${pkg.address}</p>
                    </div>
                    <i class="fas fa-chevron-right text-gray-400"></i>
                </div>
            `).join('');
        }

        // Helper Functions
        function getStatusBadge(status, small = false) {
            const configs = {
                pending: { class: 'bg-yellow-100 text-yellow-700 border-yellow-200', icon: 'clock', text: 'Pendiente' },
                transit: { class: 'bg-blue-100 text-blue-700 border-blue-200', icon: 'truck', text: 'En Tránsito' },
                delivered: { class: 'bg-green-100 text-green-700 border-green-200', icon: 'check-circle', text: 'Entregado' }
            };
            const config = configs[status];
            const sizeClass = small ? 'text-xs px-2 py-0.5' : 'text-sm px-3 py-1';
            return `<span class="${sizeClass} rounded-full border ${config.class} font-medium flex items-center gap-1 w-fit status-badge">
                <i class="fas fa-${config.icon} ${small ? 'text-[10px]' : 'text-xs'}"></i> ${config.text}
            </span>`;
        }

        function getPackageTypeLabel(type) {
            const labels = { small: 'Pequeño', medium: 'Mediano', large: 'Grande', xlarge: 'Extra Grande' };
            return labels[type] || type;
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('es-MX', { day: 'numeric', month: 'short', year: 'numeric' });
        }

        function filterStatus(status) {
            currentFilter = status;
            
            // Update buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if (btn.dataset.filter === status) {
                    btn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                    btn.classList.add('bg-primary', 'text-white');
                } else {
                    btn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                    btn.classList.remove('bg-primary', 'text-white');
                }
            });
            
            renderPackages();
        }

        function searchPackages() {
            const term = document.getElementById('search-input').value.toLowerCase();
            const cards = document.querySelectorAll('.package-card');
            
            cards.forEach(card => {
                const text = card.textContent.toLowerCase();
                card.style.display = text.includes(term) ? 'block' : 'none';
            });
        }

        // Map Functions
        function initMap() {
            if (mainMap) return;
            
            mainMap = L.map('map').setView([19.4326, -99.1332], 5);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(mainMap);
            
            updateMapMarkers();
        }

        function updateMapMarkers() {
            if (!mainMap) return;
            
            // Clear existing markers
            mainMap.eachLayer(layer => {
                if (layer instanceof L.Marker || layer instanceof L.Polyline) {
                    mainMap.removeLayer(layer);
                }
            });
            
            // Add markers and routes
            packages.forEach(pkg => {
                // Destination marker
                const marker = L.marker(pkg.destination).addTo(mainMap);
                
                const popupContent = `
                    <div class="p-3">
                        <img src="${pkg.photo}" class="w-full h-32 object-cover rounded-lg mb-2">
                        <h3 class="font-bold text-gray-800">${pkg.id}</h3>
                        <p class="text-sm text-gray-600 mb-2">${pkg.client}</p>
                        ${getStatusBadge(pkg.status, true)}
                        <button onclick="showDetail('${pkg.id}')" class="mt-2 w-full bg-primary text-white text-xs py-2 rounded hover:bg-blue-600 transition-colors">
                            Ver Detalles
                        </button>
                    </div>
                `;
                
                marker.bindPopup(popupContent);
                
                // Draw route line
                if (pkg.status !== 'pending') {
                    const latlngs = [pkg.origin, pkg.destination];
                    const color = pkg.status === 'delivered' ? '#10B981' : '#3B82F6';
                    
                    L.polyline(latlngs, {
                        color: color,
                        weight: 3,
                        opacity: 0.6,
                        dashArray: pkg.status === 'delivered' ? null : '10, 10'
                    }).addTo(mainMap);
                }
            });
            
            // Fit bounds if packages exist
            if (packages.length > 0) {
                const group = new L.featureGroup(packages.map(p => L.marker(p.destination)));
                mainMap.fitBounds(group.getBounds().pad(0.1));
            }
        }

        let formMapMarker = null;
        let selectedCoords = null;

        function initFormMap() {
            if (formMap) {
                formMap.invalidateSize();
                return;
            }
            
            formMap = L.map('form-map').setView([19.4326, -99.1332], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(formMap);
            
            // Add click handler
            formMap.on('click', function(e) {
                if (formMapMarker) {
                    formMap.removeLayer(formMapMarker);
                }
                formMapMarker = L.marker(e.latlng).addTo(formMap);
                selectedCoords = [e.latlng.lat, e.latlng.lng];
                
                // Reverse geocode (simulated)
                document.getElementById('destination-address').value = `Lat: ${e.latlng.lat.toFixed(4)}, Lng: ${e.latlng.lng.toFixed(4)}`;
            });
        }

        function handleAddressInput(e) {
            if (e.key === 'Enter') {
                geocodeAddress();
            }
        }

        function geocodeAddress() {
            const address = document.getElementById('destination-address').value;
            if (!address || !formMap) return;
            
            // Simulate geocoding with random offset from CDMX for demo
            const baseLat = 19.4326;
            const baseLng = -99.1332;
            const randomLat = baseLat + (Math.random() - 0.5) * 0.1;
            const randomLng = baseLng + (Math.random() - 0.5) * 0.1;
            
            selectedCoords = [randomLat, randomLng];
            formMap.setView(selectedCoords, 15);
            
            if (formMapMarker) {
                formMap.removeLayer(formMapMarker);
            }
            formMapMarker = L.marker(selectedCoords).addTo(formMap);
        }

        function previewImage() {
            const url = document.getElementById('package-photo').value;
            const preview = document.getElementById('image-preview');
            const img = preview.querySelector('img');
            
            if (url) {
                img.src = url;
                preview.classList.remove('hidden');
            } else {
                preview.classList.add('hidden');
            }
        }

        // CRUD Operations
        function createShipment(e) {
            e.preventDefault();
            
            const newPackage = {
                id: document.getElementById('tracking-id').value,
                client: document.getElementById('client-name').value,
                type: document.getElementById('package-type').value,
                status: document.getElementById('initial-status').value,
                origin: [19.4326, -99.1332], // Default origin
                destination: selectedCoords || [19.4326 + Math.random() * 0.1, -99.1332 + Math.random() * 0.1],
                address: document.getElementById('destination-address').value || 'Dirección no especificada',
                photo: document.getElementById('package-photo').value || 'https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=400',
                date: new Date().toISOString(),
                history: [
                    { status: document.getElementById('initial-status').value, date: new Date().toISOString(), location: 'Registro inicial' }
                ]
            };
            
            packages.unshift(newPackage);
            updateStats();
            renderPackages();
            renderRecentShipments();
            updateMapMarkers();
            
            // Reset form
            document.getElementById('shipment-form').reset();
            document.getElementById('image-preview').classList.add('hidden');
            if (formMapMarker) {
                formMap.removeLayer(formMapMarker);
                formMapMarker = null;
            }
            selectedCoords = null;
            
            // Show success and redirect
            showView('shipments');
            
            // Show notification (simple alert for demo, could be toast)
            setTimeout(() => {
                alert('¡Envío creado exitosamente!');
            }, 100);
        }

        function updatePackageStatus(id, newStatus) {
            const pkg = packages.find(p => p.id === id);
            if (!pkg) return;
            
            pkg.status = newStatus;
            pkg.history.unshift({
                status: newStatus,
                date: new Date().toISOString(),
                location: newStatus === 'delivered' ? 'Entregado al cliente' : 'Actualización de estado'
            });
            
            updateStats();
            renderPackages();
            renderRecentShipments();
            updateMapMarkers();
            
            if (selectedPackage && selectedPackage.id === id) {
                showDetail(id);
            }
        }

        // Modal Functions
        function showDetail(id) {
            selectedPackage = packages.find(p => p.id === id);
            if (!selectedPackage) return;
            
            document.getElementById('modal-tracking').textContent = selectedPackage.id;
            document.getElementById('modal-client').textContent = selectedPackage.client;
            document.getElementById('modal-image').src = selectedPackage.photo;
            document.getElementById('modal-status-badge').innerHTML = getStatusBadge(selectedPackage.status);
            document.getElementById('modal-date').textContent = formatDate(selectedPackage.date);
            document.getElementById('modal-destination').innerHTML = `<i class="fas fa-flag-checkered text-secondary"></i> ${selectedPackage.address}`;
            
            // Timeline
            const timeline = document.getElementById('modal-timeline');
            timeline.innerHTML = selectedPackage.history.map((h, index) => `
                <div class="relative flex items-start gap-4">
                    <div class="absolute left-4 top-2 w-2 h-2 rounded-full ${index === 0 ? 'bg-primary' : 'bg-gray-300'} ring-4 ring-white"></div>
                    <div class="ml-8">
                        <p class="text-sm font-medium text-gray-800">${getStatusText(h.status)}</p>
                        <p class="text-xs text-gray-500">${h.location}</p>
                        <p class="text-xs text-gray-400 mt-1">${formatDate(h.date)}</p>
                    </div>
                </div>
            `).join('');
            
            // Show modal
            const modal = document.getElementById('detail-modal');
            const content = document.getElementById('modal-content');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            setTimeout(() => {
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
                initModalMap();
            }, 10);
        }

        function closeModal() {
            const modal = document.getElementById('detail-modal');
            const content = document.getElementById('modal-content');
            
            content.classList.remove('scale-100', 'opacity-100');
            content.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                selectedPackage = null;
                if (modalMap) {
                    modalMap.remove();
                    modalMap = null;
                }
            }, 300);
        }

        function initModalMap() {
            if (!selectedPackage) return;
            
            setTimeout(() => {
                modalMap = L.map('modal-map').setView(selectedPackage.destination, 13);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(modalMap);
                
                // Add markers
                L.marker(selectedPackage.origin).addTo(modalMap).bindPopup('Origen');
                L.marker(selectedPackage.destination).addTo(modalMap).bindPopup('Destino');
                
                // Draw route
                L.polyline([selectedPackage.origin, selectedPackage.destination], {
                    color: '#3B82F6',
                    weight: 4,
                    opacity: 0.7
                }).addTo(modalMap);
                
                modalMap.fitBounds([selectedPackage.origin, selectedPackage.destination], { padding: [50, 50] });
            }, 100);
        }

        function updateStatus(status) {
            if (selectedPackage) {
                updatePackageStatus(selectedPackage.id, status);
            }
        }

        function getStatusText(status) {
            const texts = { pending: 'Pendiente de procesamiento', transit: 'En tránsito', delivered: 'Entregado' };
            return texts[status] || status;
        }

        // Close modal on outside click
        document.getElementById('detail-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        });
    </script>
</body>
</html>
